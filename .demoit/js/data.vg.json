{
    "$schema": "https://vega.github.io/schema/vega/v5.11.json",
    "width": 500,
    "height": 500,
    "padding": 5,

    "signals": [
      { "name":"region_padding", "value": "50", "bind":{ "element":"#my-controls", "input":"range" } }
    ],

    "data": [
      {
        "name": "regions",
        "values":
        [
          {"name":"vtr", "width":350, "height":150, "x":275, "y":270, "count": 2},
          {"name":"ohio", "width":350, "height":150, "x":50, "y":50, "count": 2},
          {"name":"seoul", "width":350, "height":150, "x":500, "y":50, "count": 1}
        ],

        "transform": [
          {"type":"formula", "as":"text_x","expr":"datum.x + datum.width/2"}
        ]
      }, 
      {
        "name": "mongo-status",
        "values":	
        [
          {
            "_id": 0,
            "name": "mongo1.ww.project.vtr.internal:27017",
            "syncSourceId": 3,
            "syncSourceHost": "mongo2.ww.project.vtr.internal:27017"
          },
          {
            "_id": 1,
            "name": "mongo1.ww.project.ohio.cloud:27017",
            "syncSourceId": 2,
            "syncSourceHost": "mongo2.ww.project.vtr.internal:27017"
          },
          {
            "_id": 2,
            "name": "mongo1.ww.project.seoul.cloud:27017",
            "syncSourceId": -1,
            "syncSourceHost": ""
          },
          {
            "_id": 3,
            "name": "mongo2.ww.project.vtr.internal:27017",
            "syncSourceId": 1,
            "syncSourceHost": ""
          },
          {
            "_id": 4,
            "name": "mongo2.ww.project.ohio.cloud:27017",
            "syncSourceId": 3,
            "syncSourceHost": "mongo2.ww.project.vtr.internal:27017"
          }
        ],
        "transform": [
          {"type": "formula", "as":"name_parts", "expr": "split(split(datum.name,':')[0],'.')"},
          {"type": "formula", "as":"node_name", "expr": "datum.name_parts[0]"},
          {"type": "formula", "as":"node_region", "expr": "datum.name_parts[3]"},
          {"type": "formula", "as":"index", "expr": "slice(datum.node_name,-1)-1"},

          {"type": "lookup", "from": "regions", "key": "name", "fields": ["node_region"], "as":["region"]},
          
          {"type": "formula", "as": "x1", "expr": "datum.region.x + 50 + datum.index * 150"},
          {"type": "formula", "as": "width", "expr": "region_padding * 2"},
          {"type": "formula", "as": "y1", "expr": "datum.region.y + region_padding"},
          {"type": "formula", "as": "height", "expr": "region_padding"},
          {"type": "formula", "as": "x", "expr": "datum.x1 + datum.width/2"},
          {"type": "formula", "as": "y", "expr": "datum.y1 + datum.height/2"},
          
          {"type": "formula", "as": "sourceId", "expr": "datum.syncSourceId<0 ? null : datum.syncSourceId"},
          {
            "type": "stratify",
            "key": "_id",
            "parentKey": "sourceId"
          }
          
        ]
      },

      {
        "name": "links",
        "source": "mongo-status",
        "transform": [
          { "type": "treelinks" },
          { "type": "linkpath", "shape": "curve", "orient": "horizontal" }
        ]
      }

    ],


    "scales": [
    ],
  
  
    "marks": [

      {
        "type": "path",
        "from": {"data":"links"},
        "encode": {
          "enter": {
            "path": {"field": "path"},
            "stroke": {"value": "blue"}
          }
        }
      },

      {
        "type": "rect",
        "from": {"data":"mongo-status"},
        "encode": {
          "enter": {
            "stroke": {"value": "blue"}
          },
          "update": {
            "x": {"field": "x1"},
            "y": {"field": "y1"},
            "width": {"field": "width"},
            "height": {"field": "height"}
          }
        }
      },


      {
        "type": "rect",
        "from": {"data":"regions"},
        "encode": {
          "update": {
            "x": {"field": "x"},
            "y": {"field": "y"},
            "width": {"field": "width"},
            "height": {"field": "height"},
            "stroke": {"value": "red"}
          }
        }
      },
      {
        "type": "text",
        "from": {"data":"regions"},
        "encode": {
          "update": {
            "text": {"field":"name"},
            "align": {"value":"center"},
            "baseline": {"value": "top"},
            "x": {"field": "text_x"},
            "y": {"field": "y"},
            "width": {"field": "width"},
            "height": {"field": "height"}
          }
        }
      }
  

    ]
  }